# ─────────────────────────────────────────────────────────────
# Fluentd configuration: GCP Pub/Sub → OCI Streaming (Kafka)
#
# Secrets are mounted from OCI Vault at runtime:
#   /mnt/secrets/gcp-key.json          – GCP service account key
#   /mnt/secrets/oci_auth_token        – OCI auth token
#
# All <YOUR_*> placeholders must be replaced before deployment,
# or passed via environment variables using #{ENV['VAR']}.
# ─────────────────────────────────────────────────────────────

<system>
  log_level info
</system>

# ── SOURCE: GCP Pub/Sub ──────────────────────────────────────
<source>
  @type gcloud_pubsub
  tag gcp.logs

  # GCP project and subscription
  project "#{ENV['GCP_PROJECT_ID']}"
  topic   "#{ENV['GCP_PUBSUB_TOPIC']}"
  subscription "#{ENV['GCP_PUBSUB_SUBSCRIPTION']}"

  # Credentials – path to the Vault-mounted secret file
  key /mnt/secrets/gcp-key.json

  # Pull tuning
  max_messages 1000
  return_immediately true
  pull_interval 0.5

  format json
</source>

# ── OUTPUT: OCI Streaming (Kafka protocol) ───────────────────
<match gcp.logs>
  @type kafka2

  # OCI Streaming endpoint (Kafka interface)
  brokers "#{ENV['OCI_STREAM_POOL_ENDPOINT']}:9092"
  default_topic "#{ENV['OCI_STREAM_NAME'] || 'gcp-inbound-stream'}"

  # Buffering – memory-backed for resilience
  <buffer>
    @type memory
    flush_interval 1s
    chunk_limit_size 1m
    overflow_action block
  </buffer>

  # Preserve JSON format through the pipeline
  <format>
    @type json
  </format>

  # Kafka SASL/SSL authentication for OCI Streaming
  use_event_time true
  ssl_ca_cert /etc/ssl/certs/ca-certificates.crt
  sasl_over_ssl true
  sasl_mechanism PLAIN

  # SASL credentials – username from env, password from mounted secret
  username "#{ENV['OCI_KAFKA_USERNAME']}"
  password "#{File.read('/mnt/secrets/oci_auth_token').strip}"

  client_id fluentd-bridge-container-01
</match>
